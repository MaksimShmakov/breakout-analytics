# Automarks API

Документация актуальна для текущей версии Django-приложения (ноябрь 2025).
Все URL относительно базового пути приложения (по умолчанию `https://<host>/`).

## Аутентификация и форматы
- Формат запросов и ответов — JSON (если не указано иначе).
- `GET /api/bot/<bot_name>/` открыт и не требует аутентификации.
- `POST /update_field/` доступен только авторизованным пользователям с ролью `admin`, `manager` или `marketer`. Используется cookie-сессия Django, запрос должен содержать валидный CSRF-токен.
- Поля дат принимаются в ISO-формате `YYYY-MM-DD` (для месяцев допускается `YYYY-MM`, в этом случае день автоматически берётся `01`).
- Числовые значения приводятся к типам модели: целые — integer, денежные — decimal.

Коды ответов:
- `200` — успешный ответ
- `400` — ошибка валидации/формата данных
- `401/403` — отсутствие доступа (не авторизован или роль не входит в разрешённый список)
- `404` — объект не найден

---

## 1. Получение структуры бота

`GET /api/bot/<bot_name>/`

Возвращает данные о боте, его ветках и связанных UTM-тегах. Используется, например, интеграциями с внешними бот-платформами.

### Параметры пути
- `bot_name` — системное имя бота (`marks.models.Bot.name`), регистрозависимое.

### Успешный ответ
```json
{
  "bot": "python_course_bot",
  "branches": [
    {
      "name": "Главная ветка",
      "code": "ell01",
      "tags": [
        {
          "number": "ell010001",
          "utm_source": "ads",
          "utm_medium": "cpc",
          "utm_campaign": "ell01_campaign_1",
          "utm_term": "python",
          "utm_content": "banner",
          "url": "https://t.me/python_course_bot?start=ell010001"
        }
      ]
    }
  ]
}
```

### Ошибки
- `404 {"error": "Bot not found"}` — бот с указанным именем отсутствует.

---

## 2. Точечное обновление сущностей

`POST /update_field/`

Выполняет обновление одного поля конкретной записи без полной формы. Применяется для inline-редактирования из интерфейса.

### Требования
- Пользователь должен быть авторизован и иметь роль `admin`, `manager` или `marketer`.
- Заголовки: `Content-Type: application/json`, `X-CSRFToken: <token>`.

### Тело запроса
```json
{
  "model": "plan",
  "id": 42,
  "field": "budget",
  "value": "150000.00"
}
```

### Параметры
- `model` — тип модели. Допустимые значения:
  - `plan` → `marks.models.PlanMonthly`
  - `report` → `marks.models.TrafficReport`
  - `tag` → `marks.models.Tag`
- `id` — целочисленный идентификатор записи.
- `field` — имя поля, перечень ограничен (см. таблицу ниже).
- `value` — новое значение в текстовом виде; преобразование выполняется на стороне сервера.

| model  | Разрешённые поля                                                                                                 | Тип данных |
|--------|------------------------------------------------------------------------------------------------------------------|------------|
| plan   | `budget`, `revenue_target`, `warm_leads_target`, `cold_leads_target`, `notes`                                    | decimal / int / text |
| report | `spend`, `impressions`, `clicks`, `leads_warm`, `leads_cold`, `vendor`, `notes`, `platform`, `month`             | decimal / int / text / enum / date |
| tag    | `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content`                                            | text |

### Успешный ответ
```json
{"success": true}
```

### Возможные ошибки
- `400 {"error": "Invalid JSON"}` — некорректный JSON.
- `400 {"error": "Invalid model"}` — недопустимое значение `model`.
- `400 {"error": "Field not allowed"}` — попытка изменить поле вне белого списка.
- `404 {"error": "Object not found"}` — запись с указанным `id` отсутствует.
- `400 {"error": "<описание>"}` — иные ошибки преобразования (например, неверный формат даты или числа).
- `403` — у пользователя нет прав для вызова.

---

## Дополнительно
- Маршруты, не перечисленные выше, возвращают HTML-страницы или файлы (PDF/Excel) и не предназначены для внешних интеграций.
- В каталоге `automarks/` находится заготовка Flask API (`GET /`), но она не развёрнута в текущей конфигурации Docker и не участвует в работе сервиса.
